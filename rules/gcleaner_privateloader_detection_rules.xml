<!--
  Wazuh Detection Rules for GCleaner/PrivateLoader Trojan
  Threat: GCleaner/PrivateLoader (Multi-stage Malware Loader)
  SHA256: c34601c5da3501f6ee0efce18de7e6145153ecfac2ce2019ec52e1535a4b3193

  Detection Strategy: Pyramid of Pain approach
  - Hash-based detection (Easy to evade, but fast to implement)
  - Network IOCs (Medium difficulty)
  - Behavioral detection (Hard to evade)

  Author: Wazuh Threat Detection Engineering
  Date: 2025-12-06
  Version: 1.0
-->

<group name="gcleaner,privateloader,malware,loader,trojan">

  <!-- Rule 100001: File Hash Detection - Known GCleaner/PrivateLoader Binary (SHA256) -->
  <rule id="100001" level="15">
    <if_sid>554</if_sid>
    <field name="win.eventdata.hashes" type="pcre2">SHA256=C34601C5DA3501F6EE0EFCE18DE7E6145153ECFAC2CE2019EC52E1535A4B3193|SHA256=c34601c5da3501f6ee0efce18de7e6145153ecfac2ce2019ec52e1535a4b3193</field>
    <description>GCleaner/PrivateLoader trojan detected by SHA256 hash</description>
    <mitre>
      <id>T1204.002</id>
      <tactic>Execution</tactic>
      <technique>Malicious File</technique>
    </mitre>
    <group>malware_detection,file_hash,gcleaner,privateloader,</group>
  </rule>

  <!-- Rule 100002: File Hash Detection - Known GCleaner/PrivateLoader Binary (MD5) -->
  <rule id="100002" level="15">
    <if_sid>554</if_sid>
    <field name="win.eventdata.hashes" type="pcre2">MD5=9E571DCA867C875C920F5B9E75181BC3|MD5=9e571dca867c875c920f5b9e75181bc3</field>
    <description>GCleaner/PrivateLoader trojan detected by MD5 hash</description>
    <mitre>
      <id>T1204.002</id>
      <tactic>Execution</tactic>
      <technique>Malicious File</technique>
    </mitre>
    <group>malware_detection,file_hash,gcleaner,privateloader,</group>
  </rule>

  <!-- Rule 100003: File Hash Detection - Known GCleaner/PrivateLoader Binary (Imphash) -->
  <rule id="100003" level="15">
    <if_sid>554</if_sid>
    <field name="win.eventdata.hashes" type="pcre2">IMPHASH=E92B45C54AA05EC107D5EF90662E6B33|IMPHASH=e92b45c54aa05ec107d5ef90662e6b33</field>
    <description>GCleaner/PrivateLoader trojan detected by Import Hash (Imphash)</description>
    <mitre>
      <id>T1204.002</id>
      <tactic>Execution</tactic>
      <technique>Malicious File</technique>
    </mitre>
    <group>malware_detection,file_hash,gcleaner,privateloader,</group>
  </rule>

  <!-- Rule 100004: C2 Communication - HTTP GET to GCleaner/PrivateLoader C2 Infrastructure -->
  <rule id="100004" level="12">
    <if_group>web</if_group>
    <field name="url" type="pcre2">/pineapple\.php\?pub=mixinte/</field>
    <field name="dstip" type="pcre2">45\.12\.253\.(56|72|98|75|74)</field>
    <description>GCleaner/PrivateLoader C2 communication detected - HTTP request to known C2 server with characteristic URL pattern</description>
    <mitre>
      <id>T1071.001</id>
      <tactic>Command and Control</tactic>
      <technique>Web Protocols</technique>
    </mitre>
    <group>c2_communication,network_ioc,gcleaner,privateloader,</group>
  </rule>

  <!-- Rule 100005: C2 Communication - Outbound Connection to Known GCleaner C2 IPs -->
  <rule id="100005" level="10">
    <if_group>sysmon_event3</if_group>
    <field name="win.eventdata.destinationIp" type="pcre2">45\.12\.253\.(56|72|98|75|74)</field>
    <description>Outbound network connection to GCleaner/PrivateLoader C2 IP address detected</description>
    <mitre>
      <id>T1071.001</id>
      <tactic>Command and Control</tactic>
      <technique>Web Protocols</technique>
    </mitre>
    <group>c2_communication,network_ioc,gcleaner,privateloader,</group>
  </rule>

  <!-- Rule 100006: Windows Defender Tampering - Registry Modification to Disable Defender -->
  <rule id="100006" level="14">
    <if_sid>61612</if_sid>
    <field name="win.eventdata.targetObject" type="pcre2">HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\DisableAntiSpyware|HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableRealtimeMonitoring</field>
    <field name="win.eventdata.details">DWORD \(0x00000001\)</field>
    <description>Windows Defender disabled via registry modification - Potential GCleaner/PrivateLoader defense evasion</description>
    <mitre>
      <id>T1562.001</id>
      <tactic>Defense Evasion</tactic>
      <technique>Impair Defenses: Disable or Modify Tools</technique>
    </mitre>
    <group>defense_evasion,windows_defender,gcleaner,privateloader,</group>
  </rule>

  <!-- Rule 100007: Scheduled Task Persistence - GCleaner/PrivateLoader Persistence Mechanism -->
  <rule id="100007" level="12">
    <if_sid>61616</if_sid>
    <field name="win.eventdata.targetObject" type="pcre2">HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks</field>
    <field name="win.eventdata.image" type="pcre2">(?i)\\temp\\|\\appdata\\|\\programdata\\</field>
    <description>Suspicious scheduled task created from temporary directory - Potential GCleaner/PrivateLoader persistence</description>
    <mitre>
      <id>T1053.005</id>
      <tactic>Persistence</tactic>
      <technique>Scheduled Task/Job: Scheduled Task</technique>
    </mitre>
    <group>persistence,scheduled_task,gcleaner,privateloader,</group>
  </rule>

  <!-- Rule 100008: Process Injection - WriteProcessMemory to Remote Process -->
  <rule id="100008" level="11">
    <if_sid>554</if_sid>
    <field name="win.eventdata.callTrace" type="pcre2">WriteProcessMemory</field>
    <field name="win.eventdata.sourceImage" type="pcre2">(?i)\\temp\\|\\appdata\\|\\programdata\\</field>
    <description>Suspicious WriteProcessMemory call from temporary directory - Potential GCleaner/PrivateLoader process injection</description>
    <mitre>
      <id>T1055</id>
      <tactic>Defense Evasion</tactic>
      <technique>Process Injection</technique>
    </mitre>
    <mitre>
      <id>T1055</id>
      <tactic>Privilege Escalation</tactic>
      <technique>Process Injection</technique>
    </mitre>
    <group>process_injection,gcleaner,privateloader,</group>
  </rule>

  <!-- Rule 100009: Inno Setup Abuse - Legitimate Installer Exploited by GCleaner -->
  <rule id="100009" level="10">
    <if_sid>61616</if_sid>
    <field name="win.eventdata.targetObject" type="pcre2">(?i)Inno Setup</field>
    <field name="win.eventdata.image" type="pcre2">(?i)\\temp\\|\\appdata\\|\\downloads\\</field>
    <description>Inno Setup installer executed from suspicious location - Potential GCleaner/PrivateLoader delivery mechanism</description>
    <mitre>
      <id>T1027.009</id>
      <tactic>Defense Evasion</tactic>
      <technique>Obfuscated Files or Information: Embedded Payloads</technique>
    </mitre>
    <group>inno_setup_abuse,gcleaner,privateloader,</group>
  </rule>

  <!-- Rule 100010: Taskkill Usage - AV/EDR Process Termination Attempt -->
  <rule id="100010" level="13">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.image" type="pcre2">(?i)\\taskkill\.exe</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)/F.*(MsMpEng|AvastUI|avgui|avguard|mbam|ekrn|bdagent|NortonSecurity)</field>
    <description>Taskkill used to terminate security software - Potential GCleaner/PrivateLoader defense evasion</description>
    <mitre>
      <id>T1562.001</id>
      <tactic>Defense Evasion</tactic>
      <technique>Impair Defenses: Disable or Modify Tools</technique>
    </mitre>
    <group>defense_evasion,av_evasion,gcleaner,privateloader,</group>
  </rule>

  <!-- Rule 100011: Hidden Process Creation - CreateProcess with Hidden Window -->
  <rule id="100011" level="11">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)/c\s+(start\s+)?.*\s+&amp;&amp;</field>
    <field name="win.eventdata.parentImage" type="pcre2">(?i)\\temp\\|\\appdata\\|\\programdata\\</field>
    <description>Hidden process creation detected from suspicious parent - Potential GCleaner/PrivateLoader execution</description>
    <mitre>
      <id>T1564.003</id>
      <tactic>Defense Evasion</tactic>
      <technique>Hide Artifacts: Hidden Window</technique>
    </mitre>
    <group>hidden_process,gcleaner,privateloader,</group>
  </rule>

  <!-- Rule 100012: Multi-stage Loader Behavior - Chained Process Execution Pattern -->
  <rule id="100012" level="13">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.parentImage" type="pcre2">(?i)ISCC\.exe|isetup\.exe</field>
    <field name="win.eventdata.image" type="pcre2">(?i)\\cmd\.exe</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)/c.*\.(exe|bat|ps1)</field>
    <description>Multi-stage loader behavior detected - Inno Setup spawning CMD with suspicious command line (GCleaner/PrivateLoader pattern)</description>
    <mitre>
      <id>T1059.003</id>
      <tactic>Execution</tactic>
      <technique>Command and Scripting Interpreter: Windows Command Shell</technique>
    </mitre>
    <mitre>
      <id>T1204.002</id>
      <tactic>Execution</tactic>
      <technique>User Execution: Malicious File</technique>
    </mitre>
    <group>multi_stage_loader,process_chain,gcleaner,privateloader,</group>
  </rule>

  <!-- Rule 100013: Composite Detection - Multiple GCleaner/PrivateLoader Indicators -->
  <rule id="100013" level="15" frequency="3" timeframe="300">
    <if_matched_group>gcleaner</if_matched_group>
    <same_source_ip/>
    <description>Multiple GCleaner/PrivateLoader indicators detected from same host - High confidence compromise</description>
    <mitre>
      <id>T1204.002</id>
      <tactic>Execution</tactic>
      <technique>Malicious File</technique>
    </mitre>
    <mitre>
      <id>T1071.001</id>
      <tactic>Command and Control</tactic>
      <technique>Web Protocols</technique>
    </mitre>
    <group>composite_detection,high_confidence,gcleaner,privateloader,</group>
  </rule>

</group>
